#!/bin/bash

title () {
  echo -e '\e[46m'$1'\e[49m'
}


cd ~

title 'Installing required packages...'
sudo apt install htop jq gawk git  -y

#echo 'Installing GoLang...'
#wget https://dl.google.com/go/go1.11.5.linux-arm64.tar.gz
#tar xzf go1.11.5.linux-arm64.tar.gz
#sudo mv go /usr/local

#echo 'export GOROOT=/usr/local/go' >> ~/.profile
#echo 'export GOPATH=$HOME/go' >> ~/.profile
#echo 'export PATH=$GOPATH/bin:$GOROOT/bin:$PATH' >> ~/.profile

#source .profile
#go get github.com/fullstorydev/grpcurl
#go install github.com/fullstorydev/grpcurl/cmd/grpcurl

title 'Installing docker'
curl -sSL https://get.docker.com | sh
sudo usermod -aG docker $(whoami)

echo -e '\e[46mPulling IoTeXLab iotex-core-arm image\e[49m'
sudo docker pull iotexlab/iotex-core-arm:v0.8.3

echo -e '\e[46mCreating files & folders...\e[49m'
mkdir -p ~/iotex-var
cd ~/iotex-var

export IOTEX_HOME=$PWD

mkdir -p $IOTEX_HOME/data
mkdir -p $IOTEX_HOME/log
mkdir -p $IOTEX_HOME/etc

curl https://raw.githubusercontent.com/iotexproject/iotex-bootstrap/master/config_mainnet.yaml > $IOTEX_HOME/etc/config.yaml
curl https://raw.githubusercontent.com/iotexproject/iotex-bootstrap/master/genesis_mainnet.yaml > $IOTEX_HOME/etc/genesis.yaml

echo -e '\e[46mDownloading latest blockchain snapshot...\e[49m'
curl -L https://t.iotex.me/mainnet-data-with-idx-latest > $IOTEX_HOME/data.tar.gz

echo -e '\e[46mExtracting the snapshot, please be patient...\e[49m'
tar -xvzf data.tar.gz

ip=$(wget http://ipinfo.io/ip -qO -)

title 'Your Ip is '$ip
echo 'Editing the config file'
sed -i '2s/.*/  externalHost: '$ip'/' $IOTEX_HOME/etc/config.yaml

title "Starting the node..."
sudo ~/iotex-arm/bin/startNode

title 'Your node should be running now'
title 'Please logout and login again to have your docker privileges take effect'
title 'After you login again you can:'
title 'Run startLogs to see the node logs!'
title 'Run killNode to stop the node!'
echo 'Run startNew to start the node!'
